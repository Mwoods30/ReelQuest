rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isNumber(value) {
      return value is int || value is float;
    }

    function isString(value) {
      return value is string;
    }

    function isList(value) {
      return value is list;
    }

    function allowedUserFields() {
      return [
        'level',
        'xp',
        'currency',
        'inventory',
        'achievements',
        'totalCatches',
        'totalFishSold',
        'ownedEnvironments',
        'ownedUpgrades',
        'currentEnvironment',
        'totalPurchases',
        'playerName',
        'gamesPlayed',
        'totalPlayTime',
        'createdAt',
        'lastActive',
        'email',
        'bestScore',
        'skillPoints',
        'skills',
        'prestigeLevel',
        'cosmeticSkin'
      ];
    }

    function hasOnlyUserFields(data) {
      return data.keys().hasOnly(allowedUserFields());
    }

    function addedUserKeys() {
      return request.resource.data.diff(resource.data).addedKeys();
    }

    function changedUserKeys() {
      return request.resource.data.diff(resource.data).changedKeys();
    }

    function isValidUserProfile(data) {
      return (!('level' in data) || data.level is int)
        && (!('xp' in data) || data.xp is int)
        && (!('currency' in data) || isNumber(data.currency))
        && (!('inventory' in data) || isList(data.inventory))
        && (!('achievements' in data) || isList(data.achievements))
        && (!('totalCatches' in data) || isNumber(data.totalCatches))
        && (!('totalFishSold' in data) || isNumber(data.totalFishSold))
        && (!('ownedEnvironments' in data) || isList(data.ownedEnvironments))
        && (!('ownedUpgrades' in data) || isList(data.ownedUpgrades))
        && (!('currentEnvironment' in data) || isString(data.currentEnvironment))
        && (!('totalPurchases' in data) || isNumber(data.totalPurchases))
        && (!('playerName' in data) || isString(data.playerName))
        && (!('gamesPlayed' in data) || isNumber(data.gamesPlayed))
        && (!('totalPlayTime' in data) || isNumber(data.totalPlayTime))
        && (!('email' in data) || isString(data.email))
        && (!('bestScore' in data) || isNumber(data.bestScore))
        && (!('skillPoints' in data) || data.skillPoints is int)
        && (!('skills' in data) || isList(data.skills))
        && (!('prestigeLevel' in data) || data.prestigeLevel is int)
        && (!('cosmeticSkin' in data) || isString(data.cosmeticSkin));
    }

    function isValidLeaderboardEntry(data) {
      return data.keys().hasOnly([
        'userId',
        'playerName',
        'score',
        'catches',
        'longestStreak',
        'level',
        'timestamp',
        'date'
      ])
        && data.userId is string
        && isString(data.playerName)
        && isNumber(data.score)
        && isNumber(data.catches)
        && isNumber(data.longestStreak)
        && isNumber(data.level)
        && (!('date' in data) || isString(data.date));
    }

    function isValidGameSession(data) {
      return data.keys().hasOnly([
        'userId',
        'score',
        'catches',
        'longestStreak',
        'playTime',
        'timestamp'
      ])
        && data.userId is string
        && isNumber(data.score)
        && isNumber(data.catches)
        && isNumber(data.longestStreak)
        && isNumber(data.playTime);
    }

    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId)
        && hasOnlyUserFields(request.resource.data)
        && isValidUserProfile(request.resource.data);
      allow update: if isOwner(userId)
        && isValidUserProfile(request.resource.data)
        && addedUserKeys().hasOnly(allowedUserFields())
        && changedUserKeys().hasOnly(allowedUserFields());
      allow delete: if false;
    }

    match /leaderboard/{entryId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && isValidLeaderboardEntry(request.resource.data);
      allow update, delete: if false;
    }

    match /gameSessions/{sessionId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && isValidGameSession(request.resource.data);
      allow update, delete: if false;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
